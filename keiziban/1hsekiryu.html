<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ­ãƒƒã‚¯</title>
<style>
  a.big-link {
    font-size: 2rem;      /* æ–‡å­—ã‚µã‚¤ã‚ºã‚’å¤§ãã */
    padding: 20px 40px;   /* ä½™ç™½ã‚’ã¤ã‘ã¦ãƒœã‚¿ãƒ³é¢¨ã« */
    display: inline-block;/* ãƒ–ãƒ­ãƒƒã‚¯ã£ã½ãã—ã¦ã‚¯ãƒªãƒƒã‚¯ç¯„å›²ã‚’åºƒã’ã‚‹ */
    text-decoration: none;/* ä¸‹ç·šã‚’æ¶ˆã™ */
    background: #007BFF;  /* èƒŒæ™¯è‰²ï¼ˆé’ï¼‰ */
    color: white;         /* æ–‡å­—è‰² */
    border-radius: 8px;   /* è§’ã‚’ä¸¸ã‚ã‚‹ */
  }

  a.big-link:hover {
    background: #0056b3;  /* ãƒ›ãƒãƒ¼æ™‚ã«å°‘ã—æ¿ƒã„é’ã« */
  }
</style>
<style>
body {
  margin: 0;
  font-family: sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  background: #f0f0f0;
}
#lockScreen, #protected { text-align: center; }
#protected { display: none; }
#inputDisplay { font-size: 2rem; margin-bottom: 15px; letter-spacing: 5px; }
#message { color: red; margin-top: 10px; }

.keypad {
  display: grid;
  grid-template-columns: repeat(3, 80px);
  gap: 10px;
  justify-content: center;
  margin-top: 10px;
}

button {
  font-size: 1.5rem;
  padding: 15px;
  border: none;
  border-radius: 50%;
  background: #3498db;
  color: white;
  cursor: pointer;
  box-shadow: 0 4px 6px rgba(0,0,0,0.2);
  transition: transform 0.1s, background 0.1s;
}

button:active {
  background: #2980b9;
  transform: translateY(2px);
}

/* ä¸‹æ®µãƒœã‚¿ãƒ³é…ç½® */
.button-zero { grid-column: 2; }
.button-clear { grid-column: 1; }
.button-back { grid-column: 3; }

/* iPhoneå¯¾å¿œ */
@media (max-width: 480px) {
  .keypad { grid-template-columns: repeat(3, 60px); gap: 8px; }
  button { font-size: 1.2rem; padding: 12px; }
  #inputDisplay { font-size: 1.5rem; }
}
</style>
</head>
<body>
<div id="lockScreen">
  <h2>4æ¡ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
  <div id="inputDisplay">----</div>
  <div class="keypad">
    <button>1</button><button>2</button><button>3</button>
    <button>4</button><button>5</button><button>6</button>
    <button>7</button><button>8</button><button>9</button>
    <button class="button-clear">C</button>
    <button class="button-zero">0</button>
    <button class="button-back">âŒ«</button>
  </div>
  <div id="message"></div>
</div>

<div id="protected">
  <h1>ğŸ‰ ãƒ­ãƒƒã‚¯è§£é™¤ã•ã‚Œã¾ã—ãŸï¼</h1>
  <p><a href="../1H.html" class="big-link">ã“ã“ã‚’æŠ¼ã™</a></p>
</div>

<script>
const CORRECT = "9274";
let input = "";
const display = document.getElementById("inputDisplay");
const message = document.getElementById("message");

// sessionStorageã§çŠ¶æ…‹ä¿æŒ
function getFailed() { return parseInt(sessionStorage.getItem("failedAttempts")||"0"); }
function setFailed(val) { sessionStorage.setItem("failedAttempts", val); }
function getWrong() { return parseInt(sessionStorage.getItem("wrongCount")||"0"); }
function setWrong(val) { sessionStorage.setItem("wrongCount", val); }
function getLockUntil() { return parseInt(sessionStorage.getItem("lockUntil")||"0"); }
function setLockUntil(val) { sessionStorage.setItem("lockUntil", val); }
function isAuthenticated() { return sessionStorage.getItem("authenticated")==="true"; }
function setAuthenticated(val) { sessionStorage.setItem("authenticated", val?"true":"false"); }

function updateDisplay() { display.textContent = input.padEnd(4,"-"); }
function lockScreenShow() { document.getElementById("lockScreen").style.display="block"; document.getElementById("protected").style.display="none"; }
function unlockScreenShow() { document.getElementById("lockScreen").style.display="none"; document.getElementById("protected").style.display="block"; }

function checkLock() {
  const lockUntil = getLockUntil();
  if(Date.now() < lockUntil){
    const remainSec = Math.ceil((lockUntil - Date.now())/1000);
    const min = Math.floor(remainSec/60); const sec = remainSec%60;
    message.textContent = `ãƒ­ãƒƒã‚¯ä¸­ã§ã™ã€‚ã‚ã¨${min}åˆ†${sec}ç§’`;
    return true;
  }
  return false;
}

// ãƒœã‚¿ãƒ³å‡¦ç†
document.querySelectorAll(".keypad button").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    if(checkLock()) return;
    const val = btn.textContent;
    if(val >= "0" && val <= "9" && input.length<4){ 
      input+=val; updateDisplay();
      if(input.length===4) checkPassword();
    } else if(val==="C"){ // ä¸€æ°—æ¶ˆå»
      input=""; updateDisplay(); message.textContent="";
    } else if(val==="âŒ«"){ // ä¸€æ¡æ¶ˆå»
      input=input.slice(0,-1); updateDisplay();
    }
  });
});

function checkPassword(){
  if(input===CORRECT){
    setAuthenticated(true); setFailed(0); setWrong(0); setLockUntil(0);
    unlockScreenShow(); input=""; updateDisplay();
  }else{
    let wrong=getWrong()+1; setWrong(wrong);
    let failed=getFailed();
    if(wrong>=5){
      failed++; setFailed(failed);
      const extra=failed*10*60*1000;
      setLockUntil(Date.now()+extra); setWrong(0);
      input=""; updateDisplay();
      message.textContent=`5å›é–“é•ãˆã¾ã—ãŸã€‚${extra/60000}åˆ†å¾Œã«å†å…¥åŠ›å¯èƒ½`;
      startCountdown();
    }else{
      message.textContent=`ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚æ®‹ã‚Š ${5-wrong} å›`;
      input=""; updateDisplay();
    }
  }
}

let countdownInterval=null;
function startCountdown(){
  if(countdownInterval) return;
  countdownInterval=setInterval(()=>{
    if(!checkLock()){ clearInterval(countdownInterval); countdownInterval=null; message.textContent=""; }
  },1000);
}

// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å¾Œã«åˆå›ã ã‘èªè¨¼ãƒ•ãƒ©ã‚°ä¿æŒ
let firstLoad = true;

// ãƒ–ãƒ©ã‚¦ã‚¶é›¢è„±ã§å†ãƒ­ãƒƒã‚¯ï¼ˆåˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã¯ç„¡è¦–ï¼‰
document.addEventListener("visibilitychange", ()=>{
  if(firstLoad){ firstLoad=false; return; } 
  if(document.hidden && isAuthenticated()){ 
    setAuthenticated(false); 
    lockScreenShow(); 
    message.textContent="å†åº¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; 
  }
});

// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒªãƒ­ãƒ¼ãƒ‰ä¿æŒç¢ºèª
window.onload=()=>{
  if(isAuthenticated() && !checkLock()) unlockScreenShow();
  else lockScreenShow();
  updateDisplay();
};
</script>
</body>
</html>
